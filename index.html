<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>ãŠå€¤æ®µã‚¯ã‚¤ã‚º</title>
  <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@700&family=Yuji+Boku&display=swap" rel="stylesheet">
  <style>
    html,body{
      margin:0;padding:0;
      touch-action:manipulation;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      background:#fffaf0;
      text-align:center;
      font-family: 'Yuji Boku', 'Kiwi Maru', serif, 'Arial', sans-serif;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼é˜²æ­¢ */
    }
    .screen{
        position:fixed;
        inset:0;
        display:none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        flex-direction:column;
        justify-content:center;
        align-items:center;
        opacity: 0; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        transition: opacity 0.3s ease-in-out; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³/ã‚¢ã‚¦ãƒˆ */
        background-color: #fffaf0; /* èƒŒæ™¯è‰²ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è‡ªä½“ã«æŒãŸã›ã‚‹ */
    }
    .screen.active{
        display:flex;
        opacity: 1;
    }
    /* ==== ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒ¢ãƒ¼ãƒ‰é¸æŠ ==== */
    #startScreen h1{
        font-size:34px;margin:32px 0 38px;color:#111;letter-spacing:2px;
        transition: opacity 0.3s ease-out;
    }
    #menuSel{
        display:flex;flex-direction:column;gap:20px;
        width: 200px; /* ãƒœã‚¿ãƒ³ã®å¹…ã«åˆã‚ã›ã‚‹ */
        margin: 0 auto;
    }
    .menu-btn{
      font-size:28px;padding:20px 0;width:100%; /* #menuSelã®å¹…ã«åˆã‚ã›ã‚‹ */
      background:#fff;border:3px solid #d2691e;border-radius:20px;
      color:#8b4513;font-family:'Yuji Boku','Kiwi Maru',serif;
      cursor:pointer;transition: background-color .1s, transform 0.4s ease-out, opacity 0.4s ease-out; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
      box-shadow:0 2px 8px #0001;
      transform-origin: center;
    }
    .menu-btn:active{background:#ffe4c4;}
    .menu-btn.animating-out { /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        transform: scale(1.2);
        opacity: 0;
    }
    .menu-btn.hidden-sibling { /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã§éè¡¨ç¤ºã«ã™ã‚‹ä»–ã®ãƒœã‚¿ãƒ³ */
        opacity: 0;
        pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ä¸å¯ã« */
    }


    #modeScreen, #thirtySecSel{gap:20px;}
    .mode-btn{
      font-size:22px;padding:18px 0;width:180px;margin:0 auto;
      background:#d2691e;color:#fff;border:none;border-radius:16px;
      font-family:'Yuji Boku','Kiwi Maru',serif;
      cursor:pointer;transition:.1s;
    }
    .mode-btn:active{background:#a0522d;}
    /* ==== é³¥ã‚¸ãƒ£ãƒ³ãƒ— ==== */
    #jumpScreen img{
      width:130px;height:130px; /* Placeholderã«åˆã‚ã›ã‚‹ãŸã‚é«˜ã•ã‚’æŒ‡å®š */
      user-drag:none;-webkit-user-drag:none;
      pointer-events:none;
      animation:jump 1s cubic-bezier(.46,.03,.52,.96) 3;
      border-radius: 8px; /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”»åƒã«ã‚‚è§’ä¸¸ã‚’é©ç”¨ */
    }
    @keyframes jump{
      0%   {transform:translateY(0);}
      16%  {transform:translateY(-90px);}
      32%  {transform:translateY(0);}
      49%  {transform:translateY(-70px);}
      66%  {transform:translateY(0);}
      82%  {transform:translateY(-45px);}
      100% {transform:translateY(0);}
    }
    /* ==== ã‚¯ã‚¤ã‚ºç”»é¢ ==== */
    #progress{
      font-size:18px;color:#8b4513;margin-bottom:4px;letter-spacing:2px;
      font-family:'Yuji Boku','Kiwi Maru',serif;
    }
    #question{
      font-size:26px;font-weight:bold;margin-bottom:8px;
      font-family:'Yuji Boku','Kiwi Maru',serif;
      letter-spacing:1px;
    }
    #timer{
      font-size:26px;color:#d2691e;margin-bottom:8px;font-weight:bold;
      font-family:'Yuji Boku','Kiwi Maru',serif;
    }
    #result{min-height:38px;font-size:22px;font-weight:bold;margin-bottom:8px;
      display:flex;justify-content:center;align-items:center;gap:8px;
      font-family:'Yuji Boku','Kiwi Maru',serif;}
    .result-ok{color:#22c55e;}
    .result-ng{color:#ef4444;}
    .result-icon{font-size:30px;}
    #display{
      width:120px;margin:10px auto 14px;
      padding:8px 0;font-size:26px;
      border:2px solid #8b4513;border-radius:10px;
      background:#fff;
      font-family:'Yuji Boku','Kiwi Maru',serif;
    }
    .control-buttons{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;
      width:260px;margin:0 auto 14px;
    }
    .control-buttons button,
    .numpad button{
      padding:20px;font-size:20px;
      background:#d2691e;color:#fff;border:none;border-radius:10px;
      cursor:pointer;font-family:'Yuji Boku','Kiwi Maru',serif;
      transition:.1s;
    }
    .control-buttons button:active,.numpad button:active{background:#a0522d;transform:scale(.96);}
    .numpad{
      display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:240px;margin:0 auto;
    }
    .numpad button{aspect-ratio:1/1;}
    .numpad button.zero{grid-column:span 3;aspect-ratio:auto;}
    /* ==== ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ==== */
    #menuOverlay{
      position:absolute;inset:0;background:rgba(0,0,0,.5);
      display:none;justify-content:center;align-items:center;z-index:10;
       opacity: 0; transition: opacity 0.3s ease-in-out;
    }
    #menuOverlay.active {
        display: flex;
        opacity: 1;
    }
    #menuOverlay div{
      background:#fff;padding:20px;border-radius:12px;text-align:center;
      font-family:'Yuji Boku','Kiwi Maru',serif;
    }
    #menuOverlay button{
      margin:10px;padding:10px 20px;font-size:16px;color:#fff;
      background:#d2691e;border:none;border-radius:8px;
      font-family:'Yuji Boku','Kiwi Maru',serif;
    }
    #menuOverlay button:active{background:#a0522d;}
    /* ==== çµ‚äº†ç”»é¢ ==== */
    #endHeading{
      font-size:2.2rem;
      font-family:'Yuji Boku','Kiwi Maru',serif;
      font-weight:bold;
      margin-bottom:16px;
      max-width:90%;padding:0 10px;
      line-height:1.4;white-space:pre-wrap;
      word-break:keep-all;overflow-wrap:break-word;
      letter-spacing:2px;
    }
    #wrongBox{
      max-width:480px;width:94vw;
      margin:0 auto 18px;background:#fff7ec;
      border:2px solid #d2b185;border-radius:16px;
      padding:14px 6vw 14px 6vw;
      box-sizing:border-box;
      font-family:'Yuji Boku','Kiwi Maru',serif;
      font-size:1.4rem;overflow-y:auto;max-height:180px;
      text-align:center;
    }
    #wrongBox strong{font-size:1.5rem;}
    #scoreText{margin:20px 0;font-size:22px;font-family:'Yuji Boku','Kiwi Maru',serif;}
    #endScreen button{
      padding:18px 30px;font-size:2rem;color:#fff;
      background:#d2691e;border:none;border-radius:16px;cursor:pointer;
      font-family:'Yuji Boku','Kiwi Maru',serif;
    }
    #endScreen button:active{background:#a0522d;transform:scale(.96);}
    /* ==== ä¸Šéƒ¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ ==== */
    .menubtn{
      position:absolute;top:10px;right:10px;
      background:none;border:none;font-size:32px;color:#8b4513;
      font-family:'Yuji Boku','Kiwi Maru',serif;cursor:pointer;
      z-index:5;
    }
    /* ==== æˆ»ã‚‹ãƒœã‚¿ãƒ³ ==== */
    .back-btn{
      position:absolute;left:12px;bottom:12px;
      font-size:20px;padding:12px 22px;background:#fff;border:2px solid #d2691e;
      color:#8b4513;border-radius:14px;font-family:'Yuji Boku','Kiwi Maru',serif;
      cursor:pointer;
    }
    .back-btn:active{background:#ffe4c4;}
  </style>
</head>
<body>
  <div id="startScreen" class="screen"> <h1>ãŠå€¤æ®µã‚¯ã‚¤ã‚º</h1>
    <div id="menuSel">
      <button class="menu-btn" onclick="chooseMenu('yakitori', event)">ç„¼é³¥</button>
      <button class="menu-btn" onclick="chooseMenu('otsumami', event)">ãŠã¤ã¾ã¿</button>
      <button class="menu-btn" onclick="chooseMenu('drink', event)">ãƒ‰ãƒªãƒ³ã‚¯</button>
      <button class="menu-btn" onclick="choose30Sec(event)">30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
    </div>
  </div>
  <div id="modeScreen" class="screen">
    <button class="back-btn" onclick="returnToStart()">æˆ»ã‚‹</button>
    <div style="height:20px"></div>
    <button class="mode-btn" onclick="chooseMode('all')">å…¨å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
    <button class="mode-btn" onclick="chooseMode('15')">15å•ãƒãƒ£ãƒ¬ãƒ³ã‚¸</button>
  </div>
  <div id="thirtySecSel" class="screen">
    <button class="back-btn" onclick="returnToStart()">æˆ»ã‚‹</button>
    <div style="height:20px"></div>
    <button class="mode-btn" onclick="startThirtySec('yakitori')">ç„¼é³¥</button>
    <button class="mode-btn" onclick="startThirtySec('otsumami')">ãŠã¤ã¾ã¿</button>
    <button class="mode-btn" onclick="startThirtySec('drink')">ãƒ‰ãƒªãƒ³ã‚¯</button>
  </div>
  <div id="jumpScreen" class="screen">
    <img id="niwatoriImg" src="https://placehold.co/130x130/FFF0E0/D2691E?text=ğŸ”&font=noto-sans-jp" alt="é³¥" draggable="false" onerror="this.src='https://placehold.co/130x130/EEEEEE/AAAAAA?text=ç”»åƒèª­è¾¼ã‚¨ãƒ©ãƒ¼&font=noto-sans-jp'; this.alt='ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';">
  </div>
  <div id="quizScreen" class="screen">
    <button class="menubtn" onclick="openMenu()">â˜°</button>
    <div id="progress"></div>
    <div id="question"></div>
    <div id="timer">10</div>
    <div id="result"></div>
    <div id="display">0</div>
    <div class="control-buttons">
      <button onclick="clearAnswer()">ã‚¯ãƒªã‚¢</button>
      <button onclick="checkAnswer()">è§£ç­”</button>
    </div>
    <div class="numpad">
      <button onclick="addNumber(7)">7</button><button onclick="addNumber(8)">8</button><button onclick="addNumber(9)">9</button>
      <button onclick="addNumber(4)">4</button><button onclick="addNumber(5)">5</button><button onclick="addNumber(6)">6</button>
      <button onclick="addNumber(1)">1</button><button onclick="addNumber(2)">2</button><button onclick="addNumber(3)">3</button>
      <button class="zero" onclick="addNumber(0)">0</button>
    </div>
    <div id="menuOverlay"> <div>
        <button onclick="returnToStart()">ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button><br>
        <button onclick="closeMenu()">ç¶šã‘ã‚‹</button><br>
        <button onclick="endGameEarly()">çµ‚ã‚ã‚‹</button>
      </div>
    </div>
  </div>
  <div id="endScreen" class="screen">
    <div id="endHeading"></div>
    <div id="wrongBox"></div>
    <div id="scoreText"></div>
    <button onclick="returnToStart()">ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹</button>
  </div>
  <script>
    // --- ãƒ‡ãƒ¼ã‚¿ ---
    const yakitoriMenu={
      "ã­ãã¾":160,"ã¤ãã­":200,"ã›ã›ã‚Š":160,"è‚":200,
      "è»é¶ã‚€ã­":400,"è»é¶ã‚‚ã‚‚":400,"ã¨ã‚Šã‹ã‚":120,"ã¼ã‚“ã˜ã‚Š":180,"ãƒãƒ¼ã‚ºãƒ™ãƒ¼ã‚³ãƒ³":350,
      "ã‚¦ã‚£ãƒ³ãƒŠãƒ¼":220,"ãˆã³ã—ã":160,"è¦ªã‚‚ã‚‚":160,"ãƒãƒ„":180,"ç ‚ãšã‚Š":160,"è±šè‚©ãƒ­ãƒ¼ã‚¹":300,
      "ã—ã„ãŸã‘":220,"ã—ã—ã‚ƒã‚‚":140,"ãƒ”ãƒ¼ãƒãƒ³è‚‰è©°ã‚":180,"ã†ãšã‚‰ãƒ™ãƒ¼ã‚³ãƒ³":220,"ã—ãè±š":220,
      "ãˆã®ãå·»":200,"ãƒ‹ãƒ©å·»":200,"ã­ããƒãƒ©ãƒŸ":400,"é³¥è³Šã®ãã¡ã°ã—":220,"ãƒãƒ„ãƒ¢ãƒˆ":280,"è»é¶ã‹ã‚":280,
      "ã„ã‹ã ":180,"ãªã‚“ã“ã¤":180,"ã‚¢ã‚¹ãƒ‘ãƒ©å·»":220,"ã˜ã‚ƒã“å¤©ä¸²":160,"ãƒˆãƒãƒˆå·»":200,
      "ã‚Œã‚“ã“ã‚“è‚‰è©°ã‚":250,"å’Œç‰›ãƒ›ãƒ«ãƒ¢ãƒ³":330,"ã•ã•ã¿":200
    };
    const otsumamiMenu = {
      "ã¡ãã‚ãã‚…ã†ã‚Š":550, "ã¯ã‚‹ã¾ã":680, "ã›ã‚“ã¾ã„":700
    };
    const drinkMenu = {
      "ç”Ÿä¸­":600,"ç”Ÿå¤§":1000,"ç“¶ãƒ“ãƒ¼ãƒ«":650,"ãƒãƒ³ã‚¢ãƒ«":550,"ãƒã‚¤ãƒœãƒ¼ãƒ«":500,"ãƒ¡ã‚¬ãƒã‚¤":900,
      "è§’ãƒã‚¤":580,"è§’ãƒ¡ã‚¬":980,"ã‚µãƒ¯ãƒ¼":450,"ãƒ¡ã‚¬ã‚µãƒ¯ãƒ¼":850,"éº¦ã‚½ãƒ¬":450,"ãƒ¡ã‚¬ã‚½ãƒ¬":900,"ã‚ã¤ã‹ã‚“ï¼ˆé›ªé›€ï¼‰":580,
      "èµ¤ãƒ»ç™½ãƒ¯ã‚¤ãƒ³":600,"ä¸€ç•ªæœ­":450,"ä¸€ç²’ã®éº¦":600,"äºŒéšå ‚":600,"é‡‘é»’":450,"ä¸‰å²³":550,
      "ç‡ƒå³¶":600,"è”µã®å¸«é­‚":600,"å¯Œä¹ƒå®å±±":650,"æ¿ƒé†‡æ¢…é…’":550,"ä¸‰é‡å¤§å­¦":600,"ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯":380
    };

    // --- çŠ¶æ…‹ ---
    let quizType = "yakitori";
    let mode, total, items, used, q, current='0', score, timerID, timeLeft, wrong=[];
    let answerLocked = false;
    let isThirtySec = false;
    let thirtySecTimeLeft = 0, thirtySecTimerID = null;
    let isTransitioning = false; // ç”»é¢é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ãƒ•ãƒ©ã‚°

    // --- è¦ç´  ---
    const qs = document;
    const pro=qs.getElementById('progress'), que=qs.getElementById('question'),
      tim=qs.getElementById('timer'), dis=qs.getElementById('display'), res=qs.getElementById('result'),
      startScr=qs.getElementById('startScreen'),quizScr=qs.getElementById('quizScreen'),
      endScr=qs.getElementById('endScreen'),scoreTxt=qs.getElementById('scoreText'),
      menuOvl=qs.getElementById('menuOverlay'),wrongBox=qs.getElementById('wrongBox'),
      modeScr=qs.getElementById('modeScreen'),jumpScr=qs.getElementById('jumpScreen'),
      endHeading=qs.getElementById('endHeading'),thirtySecScr=qs.getElementById('thirtySecSel');
    const startScreenTitle = startScr.querySelector('h1');
    const menuButtons = Array.from(startScr.querySelectorAll('.menu-btn'));


    // --- ç”»é¢è¡¨ç¤ºåˆ¶å¾¡ ---
    function setActiveScreen(screenElement) {
        // å…¨ã¦ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        [startScr, modeScr, thirtySecScr, jumpScr, quizScr, endScr].forEach(s => s.classList.remove('active'));
        // å¯¾è±¡ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’è¡¨ç¤º
        if (screenElement) {
            screenElement.classList.add('active');
        }
    }
    
    // --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é·ç§» ---
    function animateStartButtonTransition(clickedButton, nextScreen) {
        if (isTransitioning) return;
        isTransitioning = true;

        // ã‚¿ã‚¤ãƒˆãƒ«ã¨ä»–ã®ãƒœã‚¿ãƒ³ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        startScreenTitle.style.opacity = '0';
        menuButtons.forEach(btn => {
            if (btn !== clickedButton) {
                btn.classList.add('hidden-sibling');
            }
        });

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’æ‹¡å¤§ãƒ»ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        // å°‘ã—é…å»¶ã•ã›ã¦ã€ä»–ã®è¦ç´ ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’åˆã‚ã›ã‚‹
        setTimeout(() => {
            clickedButton.classList.add('animating-out');
        }, 50); // 50ms delay

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ç”»é¢é·ç§» (CSSã®transitionæ™‚é–“ã¨åˆã‚ã›ã‚‹)
        setTimeout(() => {
            setActiveScreen(nextScreen); // æ–°ã—ã„ç”»é¢ã‚’è¡¨ç¤º

            // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®è¦ç´ ã‚’å…ƒã«æˆ»ã™ (æ¬¡å›ã®è¡¨ç¤ºã®ãŸã‚)
            startScreenTitle.style.opacity = '1';
            menuButtons.forEach(btn => {
                btn.classList.remove('hidden-sibling');
                btn.classList.remove('animating-out'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚‚é™¤å»
            });
            isTransitioning = false;
        }, 600); // 0.05s (delay) + 0.4s (button animation) + margin ~ 0.6s
    }


    // --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢â†’ãƒ¢ãƒ¼ãƒ‰é¸æŠ ---
    function chooseMenu(type, event){
      if (isTransitioning) return;
      quizType = type;
      isThirtySec = false;
      animateStartButtonTransition(event.target, modeScr);
    }
    // 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒœã‚¿ãƒ³
    function choose30Sec(event){
      if (isTransitioning) return;
      isThirtySec = true; // 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰ã§ã‚ã‚‹ã“ã¨ã‚’å…ˆã«è¨­å®š
      animateStartButtonTransition(event.target, thirtySecScr);
    }

    // --- ãƒ¢ãƒ¼ãƒ‰é¸æŠâ†’é³¥ã‚¸ãƒ£ãƒ³ãƒ—â†’ã‚¯ã‚¤ã‚º ---
    function chooseMode(m){
      if (isTransitioning) return;
      mode = m;
      isThirtySec = false; // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
      setActiveScreen(jumpScr); // ã¾ãšã‚¸ãƒ£ãƒ³ãƒ—ç”»é¢ã¸
      resetJumpAnimation();
      setTimeout(()=>{
        // jumpScr.classList.remove('active'); // setActiveScreenãŒå‡¦ç†
        startGame(); // startGameå†…ã§quizScrã‚’activeã«ã™ã‚‹
      },1100);
    }
    
    // 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼šã‚¸ãƒ£ãƒ³ãƒ«é¸æŠã‹ã‚‰é–‹å§‹
    function startThirtySec(type){
      if (isTransitioning) return;
      quizType = type;
      isThirtySec = true;
      setActiveScreen(jumpScr); // ã¾ãšã‚¸ãƒ£ãƒ³ãƒ—ç”»é¢ã¸
      resetJumpAnimation();
      setTimeout(()=>{
        // jumpScr.classList.remove('active'); // setActiveScreenãŒå‡¦ç†
        startGame(); // startGameå†…ã§quizScrã‚’activeã«ã™ã‚‹
      },1100);
    }
    
    function resetJumpAnimation() {
        const img = document.getElementById('niwatoriImg');
        img.style.animation='none';
        void img.offsetWidth; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
        img.style.animation='';
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
    function startGame(){
      let menu = quizType==='yakitori'?yakitoriMenu:quizType==='otsumami'?otsumamiMenu:drinkMenu;
      total=(mode==='15')?Math.min(15,Object.keys(menu).length):Object.keys(menu).length;
      items=Object.keys(menu);
      used=[];score=0;wrong=[];
      answerLocked = false;
      
      setActiveScreen(quizScr); // ã‚¯ã‚¤ã‚ºç”»é¢ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«

      if(isThirtySec){
        thirtySecTimeLeft = 30;
        tim.textContent = thirtySecTimeLeft;
        if(thirtySecTimerID) clearInterval(thirtySecTimerID);
        thirtySecTimerID = setInterval(()=>{
          thirtySecTimeLeft--;
          tim.textContent = thirtySecTimeLeft;
          if(thirtySecTimeLeft<=0){
            clearInterval(thirtySecTimerID);
            if(timerID) clearInterval(timerID);
            // 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯showResultçµŒç”±ã§ã¯ãªãç›´æ¥çµ‚äº†å‡¦ç†ã¸
            showResult(false, true, 0, true); // isOverallTimeout = true
          }
        },1000);
        nextThirtySec();
      }else{
        nextQuestion();
      }
    }

    // --- é€šå¸¸ãƒ¢ãƒ¼ãƒ‰å‡ºé¡Œ ---
    function nextQuestion(){
      if(timerID) clearInterval(timerID);
      answerLocked = false;
      let menu = quizType==='yakitori'?yakitoriMenu:quizType==='otsumami'?otsumamiMenu:drinkMenu;
      if(used.length===total && total > 0){ // totalãŒ0ã®å ´åˆ(ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆ)ã¯ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é¿ã‘ã‚‹
        setActiveScreen(jumpScr);
        resetJumpAnimation();
        setTimeout(()=>{
            finish();
        },1100);
        return;
      }
      if (items.length === 0) { // ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯å³çµ‚äº†
        finish();
        return;
      }
      do{q=items[Math.floor(Math.random()*items.length)];}while(used.includes(q) && used.length < items.length); // å…¨ã¦ä½¿ç”¨æ¸ˆã¿ãªã‚‰åŒã˜å•é¡Œã‚‚è¨±å¯(ç„¡é™ãƒ«ãƒ¼ãƒ—å¯¾ç­–)
      if(used.length >= items.length && mode !== 'all' && used.length >= total) { // 15å•ãƒ¢ãƒ¼ãƒ‰ç­‰ã§å…¨ç¨®é¡å‡ºé¡Œæ¸ˆã¿ã®å ´åˆ
          finish(); return;
      }


      current='0';dis.textContent='0';res.textContent='';res.className='';
      que.textContent=`${q} ã®å€¤æ®µã¯ï¼Ÿ`;
      pro.textContent=`${used.length+1}/${total}å•ç›®`;
      tim.style.display = 'block';
      startTimer();
    }

    // --- 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”¨å‡ºé¡Œ ---
    function nextThirtySec(){
      if(timerID) clearInterval(timerID);
      answerLocked = false;
      let menu = quizType==='yakitori'?yakitoriMenu:quizType==='otsumami'?otsumamiMenu:drinkMenu;
      
      if (items.length === 0) { // ã‚¢ã‚¤ãƒ†ãƒ ãŒãªã„å ´åˆã¯å³çµ‚äº†
          if(thirtySecTimerID) clearInterval(thirtySecTimerID);
          showThirtySecEnd();
          return;
      }

      const availableItems = items.filter(item => !used.includes(item));
      if (availableItems.length === 0 && items.length > 0) { // å…¨å•ä¸€åº¦ã¯å‡ºé¡Œæ¸ˆã¿ã®å ´åˆã€usedã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†åº¦é¸ã¶
          // used = []; // 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§ã¯usedã¯æ­£è§£ä¸æ­£è§£ã®è¨˜éŒ²ã¨ã„ã†ã‚ˆã‚Šã€Œå‡ºé¡Œæ¸ˆã¿ãƒªã‚¹ãƒˆã€ãªã®ã§ã€ãƒªã‚»ãƒƒãƒˆã¯ã—ãªã„æ–¹ãŒè‰¯ã„ã‹ã‚‚ã€‚
          // åŒã˜å•é¡ŒãŒå‡ºã¦ã‚‚è‰¯ã„ãƒ«ãƒ¼ãƒ«ã¨ã™ã‚‹ã€‚
          q=items[Math.floor(Math.random()*items.length)];
      } else {
          q=availableItems.length > 0 ? availableItems[Math.floor(Math.random()*availableItems.length)] : items[Math.floor(Math.random()*items.length)];
      }

      current='0';dis.textContent='0';res.textContent='';res.className='';
      que.textContent=`${q} ã®å€¤æ®µã¯ï¼Ÿ`;
      pro.textContent=`æ­£è§£æ•°ï¼š${score}`;
      tim.style.display = 'block'; 
      tim.textContent = thirtySecTimeLeft; // 30ç§’ã‚¿ã‚¤ãƒãƒ¼ã‚’è¡¨ç¤º
    }

    // --- ã‚¿ã‚¤ãƒãƒ¼ ---
    function startTimer(){ // 10ç§’ã‚¿ã‚¤ãƒãƒ¼ (é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨)
      timeLeft=10;
      if(isThirtySec) { 
          tim.textContent = thirtySecTimeLeft; 
          return; 
      }
      tim.textContent=timeLeft;
      if(timerID) clearInterval(timerID);
      timerID=setInterval(()=>{timeLeft--;tim.textContent=timeLeft;
        if(timeLeft<=0){clearInterval(timerID);showResult(false,true);}},1000);
    }

    // --- å…¥åŠ› ---
    function addNumber(n){
      if(answerLocked) return;
      if(current.length >= 4 && n !== 0) return; 
      if(current === '0' && n === 0 && current.length === 1) return; 
      if(current.length === 4 && n === 0 && current !== '0') return; 

      current=(current==='0')?''+n:current+n;
      if(current.length > 4) current = current.substring(0,4); 
      dis.textContent=current;
    }
    function clearAnswer(){if(answerLocked) return;current='0';dis.textContent='0';}

    // --- åˆ¤å®š ---
    function checkAnswer(){
      if(answerLocked) return;
      if(current==='0' && dis.textContent === '0'){
        res.innerHTML='<span class="result-icon">âœ–</span>è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        res.className='result-ng';
        return;
      }
      answerLocked = true; 
      if(!isThirtySec && timerID) clearInterval(timerID); 

      let menu = quizType==='yakitori'?yakitoriMenu:quizType==='otsumami'?otsumamiMenu:drinkMenu;
      const ans=menu[q];
      if(parseInt(current)===ans){
        score++;
        showResult(true,false,ans);
      }
      else{
        if (q && ans !== undefined) wrong.push([q,ans,current]);
        showResult(false,false,ans);
      }
    }

    // --- çµæœè¡¨ç¤º ---
    // isOverallTimeout: 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    function showResult(ok, timeout = false, ans = 0, isOverallTimeout = false) {
        let menu = quizType === 'yakitori' ? yakitoriMenu : quizType === 'otsumami' ? otsumamiMenu : drinkMenu;

        if (q && !used.includes(q)) { // å‡ºé¡Œã•ã‚ŒãŸå•é¡Œã‚’è¨˜éŒ² (30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã§åŒã˜å•é¡ŒãŒè¤‡æ•°å›å‡ºã¦ã‚‚usedã«ã¯1å›ã ã‘)
            used.push(q);
        }

        if (isOverallTimeout) { // 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å…¨ä½“æ™‚é–“åˆ‡ã‚Œ
            // ä½•ã‚‚è¡¨ç¤ºã›ãšã€å³åº§ã«çµ‚äº†å‡¦ç†ã¸
            showThirtySecEnd();
            return;
        }
        
        if (timeout && !isThirtySec) { // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å•é¡Œã”ã¨ã®æ™‚é–“åˆ‡ã‚Œ
            const correct = menu[q];
            res.innerHTML = `<span class="result-icon">âœ–</span>æ™‚é–“åˆ‡ã‚Œï¼ æ­£è§£ã¯ ${correct} å††ã§ã™`;
            res.className = 'result-ng';
            if (q && correct !== undefined && !wrong.find(w => w[0] === q)) wrong.push([q, correct, 'æ™‚é–“åˆ‡ã‚Œ']);
        } else if (ok) {
            res.innerHTML = '<span class="result-icon">â­•</span>æ­£è§£ï¼';
            res.className = 'result-ok';
        } else if (!isThirtySec || (isThirtySec && !timeout)) { // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®ä¸æ­£è§£ or 30ç§’ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä¸­ã®ä¸æ­£è§£
             if (ans !== undefined) {
                res.innerHTML = `<span class="result-icon">âœ–</span>ä¸æ­£è§£ï¼ æ­£è§£ã¯ ${ans} å††ã§ã™`;
             } else {
                res.innerHTML = `<span class="result-icon">âœ–</span>ä¸æ­£è§£ï¼`; // æ­£è§£ã®å€¤æ®µãŒä¸æ˜ãªå ´åˆ
             }
            res.className = 'result-ng';
        }

        const delay = (ok || timeout) ? 800 : 1200;

        setTimeout(() => {
            answerLocked = false;
            if (isThirtySec) {
                if (thirtySecTimeLeft <= 0) { // å¿µã®ãŸã‚å†åº¦ãƒã‚§ãƒƒã‚¯
                    showThirtySecEnd();
                } else {
                    nextThirtySec();
                }
            } else {
                nextQuestion();
            }
        }, delay);
    }


    // --- 30ç§’çµ‚äº†æ™‚ã®ã‚¨ãƒ³ãƒ‰ç”»é¢è¡¨ç¤º ---
    function showThirtySecEnd(){
      if(thirtySecTimerID) clearInterval(thirtySecTimerID);
      if(timerID) clearInterval(timerID); // å¿µã®ãŸã‚å•é¡Œã‚¿ã‚¤ãƒãƒ¼ã‚‚
      setActiveScreen(jumpScr);
      resetJumpAnimation();
      setTimeout(()=>{
          finish();
      },1100);
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ---
    function openMenu(){ menuOvl.classList.add('active'); }
    function closeMenu(){ menuOvl.classList.remove('active'); }

    // --- çµ‚äº†å‡¦ç† ---
    function finish(){
      if(timerID) clearInterval(timerID);
      if(thirtySecTimerID) clearInterval(thirtySecTimerID);
      
      const answeredQuestions = isThirtySec ? score : used.length; 
      const totalQuestionsToConsider = isThirtySec ? score : (mode === 'all' ? items.length : Math.min(total, items.length));
      const rate = totalQuestionsToConsider > 0 ? (score / totalQuestionsToConsider) * 100 : 0;


      let comment;
       if (isThirtySec) {
          if (score >= 15) comment = 'æ—©æŠ¼ã—ãƒã‚¹ã‚¿ãƒ¼ï¼\nç´ æ™´ã‚‰ã—ã„ï¼';
          else if (score >= 10) comment = 'ã‹ãªã‚Šã®é€Ÿã•ï¼\nãŠè¦‹äº‹ï¼';
          else if (score >= 5)  comment = 'è‰¯ã„ãƒšãƒ¼ã‚¹ï¼\nã‚‚ã£ã¨ã„ã‘ã‚‹ï¼';
          else comment = 'æŒ‘æˆ¦ã‚ã‚ŠãŒã¨ã†ï¼\nã¾ãŸéŠã‚“ã§ã­ï¼';
      } else {
          if (items.length === 0) { // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
              comment = 'ãŠã£ã¨ï¼\nå•é¡Œãƒ‡ãƒ¼ã‚¿ãŒãªã„ã¿ãŸã„â€¦';
          } else if (score === totalQuestionsToConsider && score > 0) { // å…¨å•æ­£è§£ã®å ´åˆ
              comment = 'ç„¼ãé³¥å¥‰è¡Œï¼\nãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼';
          } else if (rate >= 90 && score > 0)  comment = 'ãƒ™ãƒ†ãƒ©ãƒ³ç„¼ãå¸«ï¼\nã‚ã¨ä¸€æ­©ï¼';
          else if (rate >= 70 && score > 0)  comment = 'ä¸²æ‰“ã¡è·äººè¦‹ç¿’ã„ï¼\nã„ã„ç·šã„ã£ã¦ã‚‹ï¼';
          else if (rate >= 50 && score > 0)  comment = 'ç„¼ãé³¥å¥½ã\nãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ä¸­ï¼';
          else if (rate >= 30 && score > 0)  comment = 'ã“ã‚Œã‹ã‚‰ãŒä¿®è¡Œã®æœ¬ç•ªï¼';
          else if (used.length === 0 && total > 0) comment = 'æŒ‘æˆ¦å¾…ã£ã¦ã‚‹ã‚ˆï¼'; // 1å•ã‚‚ç­”ãˆãšã«çµ‚äº†ã—ãŸå ´åˆ
          else comment = 'ä¿®è¡Œã‚ã‚‹ã®ã¿ï¼\nã¾ãšã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¦šãˆã‚ˆã†';
      }
      endHeading.innerHTML = comment.replace(/\n/g,'<br>');

      if(wrong.length){
        let html = `<strong>é–“é•ãˆãŸå•é¡Œ</strong><br>`;
        html += wrong.map(w => `${w[0]} (æ­£è§£ ${w[1]} å††ï¼‰`).join('<br>');
        wrongBox.innerHTML = html;
        wrongBox.style.display = 'block';
      }else{
        if (items.length === 0) {
             wrongBox.innerHTML = "å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        } else if (isThirtySec && score === 0) {
            wrongBox.innerHTML = "ä»Šå›ã¯æ®‹å¿µï¼ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼";
        } else if (!isThirtySec && score === 0 && used.length > 0) {
            wrongBox.innerHTML = "å…¨å•ä¸æ­£è§£ã§ã—ãŸâ€¦é ‘å¼µã‚ã†ï¼";
        } else if (score > 0 || (isThirtySec && score > 0) || (!isThirtySec && used.length === 0)) {
            wrongBox.innerHTML = (used.length === 0 && !isThirtySec) ? "æŒ‘æˆ¦ã—ã¾ã›ã‚“ã§ã—ãŸã€‚" : "å…¨å•æ­£è§£ãŠã‚ã§ã¨ã†ï¼";
        } else {
            wrongBox.innerHTML = "é–“é•ã„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼";
        }
      }
      if(isThirtySec){
        scoreTxt.innerHTML = `30ç§’ã§ ${score} å•æ­£è§£ï¼`;
      }else{
        scoreTxt.innerHTML = `${totalQuestionsToConsider > 0 ? totalQuestionsToConsider : total}å•ä¸­ ${score}å•æ­£è§£ï¼`;
      }
      closeMenu(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒé–‹ã„ã¦ã„ã‚Œã°é–‰ã˜ã‚‹
      setActiveScreen(endScr);
    }

    function endGameEarly(){
      if(timerID) clearInterval(timerID);
      if(thirtySecTimerID) clearInterval(thirtySecTimerID);
      closeMenu();
      setActiveScreen(jumpScr);
      resetJumpAnimation();
      setTimeout(()=>{
          finish(); 
      },1100);
    }

    function returnToStart(){
      if (isTransitioning) return; // é·ç§»ä¸­ã¯æˆ»ã‚‹æ“ä½œã‚’ç„¡åŠ¹åŒ–
      closeMenu();
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ã®ã‚¯ãƒ©ã‚¹ã‚„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
      startScreenTitle.style.opacity = '1';
      menuButtons.forEach(btn => {
          btn.classList.remove('hidden-sibling');
          btn.classList.remove('animating-out');
          btn.style.transform = ''; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
          btn.style.opacity = '';   // é€æ˜åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
      });
      setActiveScreen(startScr);
    }

    // åˆæœŸçŠ¶æ…‹ã§ã¯ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º
    window.onload = () => {
        setActiveScreen(startScr);
    };
  </script>
</body>
</html>
